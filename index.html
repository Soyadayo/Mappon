<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Country Explorer</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/Babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #map { height: 500px; }
    body { font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [countryData, setCountryData] = useState(null);
      const [weatherData, setWeatherData] = useState(null);
      const [newsData, setNewsData] = useState([]);
      const [selectedCountry, setSelectedCountry] = useState(null);
      const [map, setMap] = useState(null);
      const [error, setError] = useState(null);

      // Replace with your API keys and GeoJSON URL
      const OPENWEATHER_API_KEY = 'YOUR_OPENWEATHERMAP_API_KEY'; // Replace with your key
      const NEWS_API_KEY = 'YOUR_NEWSAPI_KEY'; // Replace with your key
      const GEOJSON_URL = 'https://raw.githubusercontent.com/soyadayo/mappon/main/countries.geojson';
      // Optional CORS proxy for GeoJSON if CORS issues occur
      // const GEOJSON_URL = 'https://cors-anywhere.herokuapp.com/https://raw.githubusercontent.com/soyadayo/mappon/main/countries.geojson';

      // Initialize map
      useEffect(() => {
        try {
          const mapInstance = L.map('map').setView([0, 0], 2);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(mapInstance);
          setMap(mapInstance);

          // Load GeoJSON
          axios.get(GEOJSON_URL)
            .then(response => {
              L.geoJSON(response.data, {
                style: { fillColor: '#3388ff', weight: 1, color: '#fff', fillOpacity: 0.7 },
                onEachFeature: (feature, layer) => {
                  layer.on({
                    click: () => handleCountryClick(feature, layer, mapInstance),
                    mouseover: () => layer.setStyle({ fillColor: '#ff5733' }),
                    mouseout: () => layer.setStyle({ fillColor: '#3388ff' })
                  });
                }
              }).addTo(mapInstance);
            })
            .catch(err => {
              console.error('Failed to load GeoJSON:', err);
              setError('Could not load map data. Check GeoJSON URL or CORS settings.');
            });

          return () => mapInstance.remove();
        } catch (err) {
          console.error('Map initialization error:', err);
          setError('Failed to initialize map.');
        }
      }, []);

      // Handle country click
      const handleCountryClick = async (feature, layer, mapInstance) => {
        const cca2 = feature.properties.cca2;
        setSelectedCountry(cca2);
        setError(null);

        // Fetch country data
        try {
          const countryRes = await axios.get(`https://restcountries.com/v3.1/alpha/${cca2}`);
          setCountryData(countryRes.data[0]);
        } catch (error) {
          console.error('Error fetching country data:', error);
          setError('Failed to load country details.');
        }

        // Fetch weather data
        try {
          const centroid = turf.centroid(feature).geometry.coordinates;
          const weatherRes = await axios.get(
            `https://api.openweathermap.org/data/2.5/weather?lat=${centroid[1]}&lon=${centroid[0]}&appid=${733f811ffacc68efe08bb31549727912}&units=metric`
          );
          setWeatherData(weatherRes.data);
        } catch (error) {
          console.error('Error fetching weather data:', error);
          setError('Failed to load weather data. Check API key.');
        }

        // Fetch news data
        try {
          const newsRes = await axios.get(
            `https://newsapi.org/v2/top-headlines?country=${cca2.toLowerCase()}&apiKey=${f25cbdde9c324c558cce22e2e0cec50c}`
          );
          setNewsData(newsRes.data.articles.slice(0, 3));
        } catch (error) {
          console.error('Error fetching news data:', error);
          setError('Failed to load news data. Check API key or country code.');
        }

        // Zoom to country
        try {
          const bounds = layer.getBounds();
          mapInstance.fitBounds(bounds);
        } catch (err) {
          console.error('Error zooming to country:', err);
        }
      };

      return (
        <div className="p-4 max-w-7xl mx-auto">
          <h1 className="text-3xl font-bold mb-4">Country Explorer</h1>
          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}
          <div id="map" className="mb-4"></div>
          {selectedCountry && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white p-4 rounded shadow">
                <h2 className="text-xl font-semibold">Country Details</h2>
                {countryData ? (
                  <div>
                    <p><strong>Name:</strong> {countryData.name.common}</p>
                    <p><strong>Capital:</strong> {countryData.capital?.[0] || 'N/A'}</p>
                    <p><strong>Population:</strong> {countryData.population.toLocaleString()}</p>
                    <p><strong>Area:</strong> {countryData.area?.toLocaleString() || 'N/A'} km²</p>
                    <p><strong>Currency:</strong> {Object.values(countryData.currencies || {})[0]?.name || 'N/A'}</p>
                    <img src={countryData.flags.png} alt="Flag" className="w-32 mt-2" />
                  </div>
                ) : (
                  <p>Loading country data...</p>
                )}
              </div>
              <div className="bg-white p-4 rounded shadow">
                <h2 className="text-xl font-semibold">Weather</h2>
                {weatherData ? (
                    <div>
                      <p><strong>Location:</strong> {weatherData.name}</p>
                      <p><strong>Temperature:</strong> {weatherData.main.temp}°F</p>
                      <p><strong>Condition:</strong> {weatherData.weather[0].description || 'N/A'}</p>
                      <img
                        src={`http://openweathermap.org/img/wn/${weatherData.weather[0].icon}.png`}
                        alt="Weather Icon"
                      />
                    </div>
                  ) : (
                    <p>Loading weather data...</p>
                  )}
              </div>
              <div className="bg-white p-4 rounded shadow md:col-span-2">
                <h2 className="text-xl font-semibold">Top News</h2>
                {newsData.length > 0 ? (
                  <ul className="list-disc pl-5">
                    {newsData.map((article, index) => (
                      <li key={index} className="mb-2">
                        <a href={article.url} target="_blank" rel="noopener" href={article} className="text-blue-600 hover:underline">
                          {article.title}
                        </a>
                        <p className="text-sm text-gray-600">{article.source.name}</p>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p>No news available.</p>
                )}
              </div>
          )}
        </div>
      );
    };

    // Render the app
    try {
      ReactDOM.render(<App />, document.getElementById('root'));
    } catch (err) {
      console.error('Error loading application:', err);
      document.getElementById('root').innerHTML = '<p>Error loading application. Check console for details.</p>';
    }
  </script>
</div>
</body>
</html>
